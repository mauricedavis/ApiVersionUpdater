<template>
    <lightning-card title="API Version Updater" icon-name="custom:custom63">
        <div slot="actions">
            <lightning-badge label={orgContext.orgName} class="slds-m-right_small"></lightning-badge>
            <lightning-badge label={orgTypeLabel} class={orgTypeBadgeClass}></lightning-badge>
            <lightning-button-icon 
                icon-name="utility:refresh" 
                alternative-text="Refresh"
                onclick={handleRefresh}
                class="slds-m-left_small">
            </lightning-button-icon>
        </div>

        <template if:true={isLoading}>
            <div class="slds-is-relative slds-p-around_large">
                <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
            </div>
        </template>

        <template if:false={isLoading}>
            <template if:true={error}>
                <div class="slds-p-around_medium">
                    <div class="slds-notify slds-notify_alert slds-alert_error" role="alert">
                        <span class="slds-assistive-text">error</span>
                        <lightning-icon icon-name="utility:error" size="small" class="slds-m-right_x-small"></lightning-icon>
                        <h2>{error}</h2>
                    </div>
                </div>
            </template>

            <div class="slds-p-around_medium">
                <!-- Progress Stepper -->
                <c-progress-stepper 
                    current-step={workflowStep}
                    completed-steps={completedSteps}
                    onstepclick={handleStepClick}>
                </c-progress-stepper>

                <!-- Status Summary Card -->
                <c-status-summary-card
                    session={session}
                    scan-name={currentScanName}
                    scan-status={currentScanStatus}
                    scan-started-at={currentScanStartedAt}
                    findings-count={findingsCount}
                    alerts-count={alertsCount}
                    components-needing-upgrade={componentsNeedingUpgrade}
                    plan-name={currentPlanName}
                    plan-status={currentPlanStatus}
                    plan-item-count={changeItemsCount}
                    deployment-status={currentDeploymentStatus}
                    target-api-version={settings.targetApiVersion}
                    onclearsession={handleClearSession}
                    onviewscan={handleScanSelect}
                    onviewplan={handlePlanSelect}
                    onviewdeployment={handleViewDeployment}>
                </c-status-summary-card>

                <!-- Navigation Tabs -->
                <lightning-tabset active-tab-value={activeTab} onselect={handleTabSelect}>
                    <lightning-tab label="Dashboard" value="dashboard" icon-name="utility:chart">
                        <div class="slds-p-around_small">
                            <c-inventory-panel 
                                inventory-counts={inventoryCounts}
                                version-distribution={versionDistribution}
                                compliance-metrics={complianceMetrics}
                                target-version={settings.targetApiVersion}
                                scope-policy={settings.scopePolicy}
                                onrefresh={handleInventoryRefresh}
                                onstartscan={handleStartScan}
                                ontypechange={handleTypeChange}>
                            </c-inventory-panel>
                        </div>
                    </lightning-tab>

                    <lightning-tab label="Scans & Findings" value="scanfindings" icon-name="utility:search">
                        <lightning-tabset variant="scoped" active-tab-value={activeScanSubTab}>
                            <!-- Current Scan Sub-Tab -->
                            <lightning-tab label="Current Scan" value="current">
                                <div class="slds-p-around_small">
                                    <!-- Scan Status Section -->
                                    <template lwc:if={hasScan}>
                                        <div class="slds-m-bottom_medium">
                                            <lightning-card title="Scan Status" icon-name="utility:search">
                                                <div class="slds-p-around_medium">
                                                    <div class="slds-grid slds-gutters">
                                                        <div class="slds-col slds-size_1-of-5">
                                                            <div class="slds-text-title_caps slds-m-bottom_xx-small">Status</div>
                                                            <lightning-badge label={currentScanStatus} class={scanStatusBadgeClass}></lightning-badge>
                                                        </div>
                                                        <div class="slds-col slds-size_1-of-5">
                                                            <div class="slds-text-title_caps slds-m-bottom_xx-small">Started</div>
                                                            <template lwc:if={currentScanStartedAt}>
                                                                <lightning-formatted-date-time 
                                                                    value={currentScanStartedAt}
                                                                    year="numeric" month="short" day="2-digit"
                                                                    hour="2-digit" minute="2-digit">
                                                                </lightning-formatted-date-time>
                                                            </template>
                                                            <template lwc:else>-</template>
                                                        </div>
                                                        <div class="slds-col slds-size_1-of-5">
                                                            <div class="slds-text-title_caps slds-m-bottom_xx-small">Findings</div>
                                                            <span>{findingsCount}</span>
                                                        </div>
                                                        <div class="slds-col slds-size_1-of-5">
                                                            <div class="slds-text-title_caps slds-m-bottom_xx-small">Alerts</div>
                                                            <span class="slds-text-color_error">{alertsCount}</span>
                                                        </div>
                                                        <div class="slds-col slds-size_1-of-5">
                                                            <div class="slds-text-title_caps slds-m-bottom_xx-small">Target API</div>
                                                            <span>v{settings.targetApiVersion}</span>
                                                        </div>
                                                    </div>
                                                    
                                                    <template lwc:if={isScanRunning}>
                                                        <div class="slds-m-top_medium">
                                                            <lightning-progress-bar value="50" size="small"></lightning-progress-bar>
                                                            <div class="slds-text-align_center slds-m-top_x-small slds-text-color_weak">
                                                                Processing...
                                                            </div>
                                                        </div>
                                                        <div class="slds-m-top_medium slds-text-align_center">
                                                            <lightning-button 
                                                                variant="destructive" 
                                                                label="Cancel Scan" 
                                                                onclick={handleCancelScan}>
                                                            </lightning-button>
                                                        </div>
                                                    </template>
                                                </div>
                                            </lightning-card>
                                        </div>
                                    </template>

                                    <!-- Findings Section -->
                                    <template lwc:if={hasScanResults}>
                                        <c-findings-panel
                                            scan-id={selectedScanId}
                                            findings={findings}
                                            findings-summary={findingsSummary}
                                            target-version={settings.targetApiVersion}
                                            scope-policy={settings.scopePolicy}
                                            oncreateplan={handleCreatePlan}
                                            onshowerror={handleShowError}>
                                        </c-findings-panel>
                                    </template>

                                    <!-- Empty State -->
                                    <template lwc:if={showScanEmptyState}>
                                        <lightning-card title="Current Scan" icon-name="utility:search">
                                            <div class="slds-p-around_large slds-text-align_center">
                                                <lightning-icon icon-name="utility:info" size="large" class="slds-m-bottom_small"></lightning-icon>
                                                <h3 class="slds-text-heading_medium">No Active Scan</h3>
                                                <p class="slds-text-body_regular slds-text-color_weak slds-m-top_small">
                                                    Start a compliance scan from the Dashboard to analyze your components.
                                                </p>
                                            </div>
                                        </lightning-card>
                                    </template>
                                </div>
                            </lightning-tab>

                            <!-- Scan History Sub-Tab -->
                            <lightning-tab label="Scan History" value="history">
                                <div class="slds-p-around_small">
                                    <lightning-card title="Scan History" icon-name="utility:clock">
                                        <div class="slds-p-around_medium">
                                            <template lwc:if={hasRecentScans}>
                                                <lightning-datatable
                                                    key-field="scanId"
                                                    data={recentScansData}
                                                    columns={scanHistoryColumns}
                                                    hide-checkbox-column
                                                    onrowaction={handleScanHistoryAction}>
                                                </lightning-datatable>
                                            </template>
                                            <template lwc:else>
                                                <div class="slds-text-align_center slds-text-color_weak slds-p-around_large">
                                                    <lightning-icon icon-name="utility:info" size="large" class="slds-m-bottom_small"></lightning-icon>
                                                    <p>No scans have been run yet.</p>
                                                    <p class="slds-m-top_small">Start a scan from the Dashboard to get started.</p>
                                                </div>
                                            </template>
                                        </div>
                                    </lightning-card>
                                </div>
                            </lightning-tab>
                        </lightning-tabset>
                    </lightning-tab>

                    <lightning-tab label="Change Plan" value="changeplan" icon-name="utility:checkin"
                        disabled={planTabDisabled}>
                        <div class="slds-p-around_small">
                            <template lwc:if={hasChangePlan}>
                                <c-change-plan-panel
                                    change-plan={changePlan}
                                    change-items={changeItems}
                                    deployment-run-id={currentDeploymentRunId}
                                    onexecuteplan={handleExecutePlan}
                                    onplanreset={handlePlanReset}>
                                </c-change-plan-panel>
                            </template>
                            <template lwc:else>
                                <div class="slds-illustration slds-illustration_small">
                                    <div class="slds-text-longform">
                                        <h3 class="slds-text-heading_medium">No Change Plan</h3>
                                        <p class="slds-text-body_regular">Create a change plan from Scans & Findings after completing a scan.</p>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </lightning-tab>

                    <lightning-tab label="Backup & Restore" value="backup" icon-name="utility:undo"
                        disabled={backupTabDisabled}>
                        <div class="slds-p-around_small">
                            <c-backup-restore-panel
                                deployment-run-id={currentDeploymentRunId}
                                plan-id={currentPlanId}
                                has-backup={hasBackup}
                                onbackupcleanedup={handleBackupCleanedUp}>
                            </c-backup-restore-panel>
                        </div>
                    </lightning-tab>

                    <lightning-tab label="Settings" value="settings" icon-name="utility:settings">
                        <div class="slds-p-around_small">
                            <div class="slds-grid slds-gutters">
                                <div class="slds-col slds-size_1-of-2">
                                    <lightning-card title="Scan Settings">
                                        <div class="slds-p-horizontal_medium">
                                            <lightning-combobox
                                                name="targetApiVersion"
                                                label="Target API Version"
                                                value={settings.targetApiVersion}
                                                options={apiVersionOptions}
                                                onchange={handleSettingChange}>
                                            </lightning-combobox>

                                            <lightning-dual-listbox
                                                name="includedTypes"
                                                label="Component Types"
                                                source-label="Available"
                                                selected-label="Selected"
                                                options={componentTypeOptions}
                                                value={settings.includedTypes}
                                                onchange={handleSettingChange}
                                                class="slds-m-top_medium">
                                            </lightning-dual-listbox>

                                            <lightning-combobox
                                                name="scopePolicy"
                                                label="Scope Policy"
                                                value={settings.scopePolicy}
                                                options={scopePolicyOptions}
                                                onchange={handleSettingChange}
                                                class="slds-m-top_medium">
                                            </lightning-combobox>
                                        </div>
                                    </lightning-card>
                                </div>

                                <div class="slds-col slds-size_1-of-2">
                                    <lightning-card title="Deployment Settings">
                                        <div class="slds-p-horizontal_medium">
                                            <lightning-combobox
                                                name="incrementPolicy"
                                                label="Increment Policy"
                                                value={settings.incrementPolicy}
                                                options={incrementPolicyOptions}
                                                onchange={handleSettingChange}>
                                            </lightning-combobox>

                                            <lightning-input
                                                type="number"
                                                name="maxDeltaPerDeploy"
                                                label="Max Version Delta per Deploy"
                                                value={settings.maxDeltaPerDeploy}
                                                min="1"
                                                max="20"
                                                onchange={handleSettingChange}
                                                class="slds-m-top_medium">
                                            </lightning-input>

                                            <lightning-checkbox-group
                                                name="deployOptions"
                                                label="Deploy Options"
                                                options={deployOptionsList}
                                                value={selectedDeployOptions}
                                                onchange={handleDeployOptionsChange}
                                                class="slds-m-top_medium">
                                            </lightning-checkbox-group>
                                        </div>
                                    </lightning-card>

                                    <div class="slds-m-top_medium">
                                        <lightning-button 
                                            variant="brand" 
                                            label="Save Settings"
                                            onclick={handleSaveSettings}>
                                        </lightning-button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </lightning-tab>
                </lightning-tabset>
            </div>
        </template>
    </lightning-card>
</template>
